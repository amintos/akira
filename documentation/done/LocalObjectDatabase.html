<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9: http://docutils.sourceforge.net/" />
<title>LocalObjectDatabase</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7056 2011-06-17 10:50:48Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="localobjectdatabase">
<h1 class="title">LocalObjectDatabase</h1>

<div class="section" id="how-references-can-be-used">
<h1>How references can be used</h1>
<p>Objects can be stored in a LocalObjectDatabase with <em>localObjectDatabase.store(anObject)</em>.
This function returns a DatabaseReference to the object.
A simplified view of these objects can be seen below.</p>
<p><img alt="classDiagramLocal" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_class_diagram_local.png" /></p>
<p>All references have a <em>process</em> attribute. So one can send calls to the objects original process.
Those calls may include such a DatabaseReference.
When deserialized in its orginal process, the reference object becomes a local one.
One can test on this with <em>isLocal()</em>.
Local references have a <em>value</em> attribute for the referenced object.
So one can access the object once one is in the objects process.</p>
<p>If you want to use reference proxies to objects see this: <a class="reference external" href="reference.rst">(rst)</a> <a class="reference external" href="reference.html">(html)</a></p>
</div>
<div class="section" id="how-references-work">
<h1>How references work</h1>
<p>A LocalObjectDatabase is a id-to-object storage.
Objects can be stored under multiple references and such under multiple ids.</p>
<p>There are three kinds of references present.
Although they may reference the same object, those three types are used according to the process
the reference object is in and how it got there.</p>
<p><img alt="classDiagram" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_class_diagram.png" /></p>
<p>All references have a attribute <em>process</em> representing the process of the referenced object.
Also they all have an <em>id</em> and the <em>database</em> they are stored in.
The <em>id</em>, the <em>process</em> and the <em>database</em> together identify an object.
The process is nescessairy because the database exists in every process.</p>
<p>See the following illustrations for how references are used.</p>
<p><img alt="explanation" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_explanation.png" /></p>
<p>Below LocalDatabaseReferences are used in the process where the referenced object is.</p>
<p><img alt="local" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_local.png" /></p>
<p>They have a <em>value</em> that can be set and got. This values is looked up and stored in the database under the id of the reference.
If the reference gets deleted the id &quot;1&quot; is popped from the database.</p>
<p>See what happens when an object crosses border to an other process:</p>
<p><img alt="direct" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_direct.png" /></p>
<p>First the object is stored under the id &quot;2&quot; . Then a reference constructor is sent to the other process.
In the other process a RemoteReference is built that directly references the object under the id 2.
If the reference is deleted a call is made to the process that pops the id &quot;2&quot; from the database.</p>
<p><img alt="indirect1" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_indirect_1.png" /></p>
<p>When a direct reference is sent to another process it can not get a new id for the object. Sending must be fast.
Instead the direct reference is referenced by the IndirectRemoteDatabaseReference.
This prevents the deletion of the object under id &quot;2&quot; in case the direct reference is deleted.</p>
<p><img alt="indirect2" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_indirect_2.png" /></p>
<p>When the indirect reference is created a call is sent to the original process to get a new direct reference.</p>
<p>The old reference is freed:</p>
<p><img alt="indirect3" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_indirect_3.png" /></p>
<p>If below a indirect reference is sent to another process, almost the same happens.</p>
<p><img alt="indirect4" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_indirect_4.png" /></p>
<p>The difference is the following:
The new indirect reference references the direct &quot;3&quot; instead of the indirect &quot;3&quot;.
Resulting in:</p>
<p><img alt="indirect5" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_indirect_5.png" /></p>
</div>
<div class="section" id="removed-race-condition">
<h1>Removed Race-condition</h1>
<p>Imagin the following scenario:</p>
<p>The indirect reference in the bottom was created in another process before the reference on the right received a new id.
As shown with the red arrow, it does reference the direct reference but the indirect one.</p>
<p>The race condition looks like this:</p>
<blockquote>
<ol class="arabic simple">
<li>The request for id 4 is sent.</li>
<li>The request for id &quot;3&quot; is finished</li>
<li>The direct reference for &quot;2&quot; is deleted, not needed anymore.</li>
<li>The object is popped from database under id &quot;2&quot;</li>
<li>The request for a new id &quot;4&quot; arrives and tries to access the object under id &quot;2&quot; - an invalid operation.</li>
</ol>
</blockquote>
<p><img alt="raceCondition" src="https://raw.github.com/amintos/akira/playground/documentation/images/LocalObjectDatabase_reference_race.png" /></p>
<p>But this race-condition is removed by referencing the direct references by indirect references.
So only if those indirect references receive a new id, the direct references can be freed if really no longer required.</p>
</div>
</div>
</body>
</html>
